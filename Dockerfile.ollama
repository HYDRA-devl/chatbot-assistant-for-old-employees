# Production-ready Ollama Dockerfile for Cloud Deployment
# Optimized for Railway, Render, or any cloud platform

FROM ollama/ollama:latest

EXPOSE 11434

ENV OLLAMA_HOST=0.0.0.0:11434
ENV OLLAMA_MODELS=/models

# Create models directory
RUN mkdir -p /models

# Startup script with health check
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "================================="\n\
echo "Starting Ollama Server..."\n\
echo "================================="\n\
\n\
# Start Ollama in background\n\
ollama serve &\n\
OLLAMA_PID=$!\n\
\n\
# Wait for Ollama to be ready\n\
echo "Waiting for Ollama to start..."\n\
for i in {1..30}; do\n\
    if curl -s http://localhost:11434/api/tags >/dev/null 2>&1; then\n\
        echo "Ollama is ready!"\n\
        break\n\
    fi\n\
    echo "Waiting... ($i/30)"\n\
    sleep 2\n\
done\n\
\n\
# Check and pull model if needed\n\
MODEL="phi3:mini"\n\
echo "Checking for model: $MODEL"\n\
\n\
if ollama list | grep -q "$MODEL"; then\n\
    echo "✓ Model $MODEL already exists"\n\
else\n\
    echo "⚠ Model $MODEL not found, downloading..."\n\
    echo "This may take 5-10 minutes on first run"\n\
    ollama pull $MODEL\n\
    echo "✓ Model $MODEL downloaded successfully"\n\
fi\n\
\n\
echo "================================="\n\
echo "Ollama is ready to accept requests"\n\
echo "Model: $MODEL"\n\
echo "Port: 11434"\n\
echo "================================="\n\
\n\
# Keep container running\n\
wait $OLLAMA_PID' > /start.sh && chmod +x /start.sh

HEALTHCHECK --interval=30s --timeout=10s --start-period=5m --retries=3 \
  CMD curl -f http://localhost:11434/api/tags || exit 1

CMD ["/start.sh"]
